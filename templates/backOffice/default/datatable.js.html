<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.10/lodash.min.js"></script>
<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.2/flatpickr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.2/l10n/fr.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.10.20/dataRender/ellipsis.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.2/flatpickr.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.2/themes/airbnb.css">
<script type="application/javascript">

    var all_info = {$all_info|@json_encode nofilter};


    $('body').on('click', '.status-button', function (e) {
        e.preventDefault();

        let elem = e.currentTarget;
        let url = elem.href;

        elem.setAttribute('disabled', 'disabled');

        $.ajax({
            url: url,
            error: function (e) {

            }
        }).always(function () {
            // remove disabled once ajax call is finished
            elem.removeAttribute("disabled");
        });

        // reload the datatable to display new results and keep old page
        $('#dataTableGiftCard').DataTable().ajax.reload(null, false);
    });

    $('body').on('click', '.edit-gc-button', function (e) {
        e.preventDefault();
    });

    var table = $('#dataTableGiftCard').DataTable({
        scrollX: true,
        order: [[0, "desc"]],
        drawCallback: function (oSettings) {
        },
        ajax: '{url path="/admin/module/theliagiftcard/show"}',
        method: 'GET',
        columnDefs: {$columnsDefinitionTransaction|@json_encode nofilter}.concat([
            {
                targets: [0],
                render: function (data, type, row, meta) {
                    return data;
                }
            },
            {
                targets: [1],
                render: function (data, type, row, meta) {
                    return (data) ? `<a href="{url path='admin/order/update/'}` + data + `">` + all_info['orders'][data] + `</a>` : "{intl l='Generated by Admin' d='theliagiftcard.bo.default'}";
                }
            },
            {
                targets: [3],
                render: function (data, type, row, meta) {
                    return (data) ? all_info['sponsor_customers'][data] : "{config key="store_name"}";
                }
            },
            {
                targets: [4],
                render: function (data, type, row, meta) {
                    return (data) ? all_info['beneficiary_customers'][data] : "{intl l='Not used' d='theliagiftcard.bo.default'}";
                }
            },
            {
                targets: [9],
                render: function (data, type, row, meta) {
                    return (!data) ? "{intl l='Not active' d='theliagiftcard.bo.default'}" : "{intl l='Active' d='theliagiftcard.bo.default'}";
                }
            },
            {
                targets: [10],
                render: function (data, type, row, meta) {
                    let status = row[9];
                    let code = row[2];
                    if (status) {
                        whole_msg = ''
                        {foreach from=$all_info["languages"] item=lang}
                        whole_msg += '<a class="btn btn-default" data-toggle="modal"' +
                            'href="' + '{url path="/admin/module/theliagiftcard/config/send/pdf" l=$lang.locale}&code=' + code + '"' +
                            'title="{intl l="GENERATE_PDF_GIFT_CARD" d="theliagiftcard.bo.default"}"' +
                            'target="_blank"><img src="' + '{image file="assets/img/flags/{$lang.code}.png"}' + '" alt="' + "{$lang.title}" + '"/>' +
                            '</a>'

                        {/foreach}
                        return whole_msg;
                    } else
                        return ""
                }
            },
            {
                targets: [11],
                render: function (data, type, row, meta) {
                    let status = row[9];
                    let code = row[2];
                    if (status)
                        return '<a class="btn status-button btn-success btn-default" href="{url path="/admin/module/theliagiftcard/deactivate" code=row_code}" title="{intl l="Deactivate_GIFT_CARD" d="theliagiftcard.bo.default"}"><span class="glyphicon glyphicon-off"></span></a>'.replace('row_code', code);
                    return '<a class="btn status-button btn-danger btn-default" href="{url path="/admin/module/theliagiftcard/activate" code=row_code}" title="{intl l="Activate_GIFT_CARD" d="theliagiftcard.bo.default"}"><span class="glyphicon glyphicon-off"></span></a>'.replace('row_code', code);
                }
            },
            {
                targets: [12],
                render: function (data, type, row, meta) {
                    let code = row[2];
                    return '<a class="btn status-button btn-default show_manualy_edit_card_gift_dialog" data-toggle="modal" data-target="#manualy_edit_card_gift_dialog" data-id="' + row[0] + '" data-code="' + code + '" title="{intl l="EDIT_GIFT_CARD" d="theliagiftcard.bo.default"}"><span class="glyphicon glyphicon-list-alt"></span></a>';
                }
            }
        ]),
        language: {
            "sProcessing": "{intl l='Processing...' d='theliagiftcard.bo.default'}",
            "sSearch": "{intl l='Search' d='theliagiftcard.bo.default'} ",
            "sLengthMenu": "{intl l='Display' d='theliagiftcard.bo.default'} _MENU_ {intl l='elements' d='theliagiftcard.bo.default'}",
            "sInfo": "{intl l='Displaying elements from' d='theliagiftcard.bo.default'} _START_ {intl l='to' d='theliagiftcard.bo.default'} _END_ {intl l='on' d='theliagiftcard.bo.default'} _TOTAL_ {intl l='elements' d='theliagiftcard.bo.default'}",
            "sInfoEmpty": "{intl l='Displaying elements from' d='theliagiftcard.bo.default'} 0 {intl l='to' d='theliagiftcard.bo.default'} _END_ {intl l='on' d='theliagiftcard.bo.default'} _TOTAL_ {intl l='elements' d='theliagiftcard.bo.default'}",
            "sInfoFiltered": "({intl l='filtered from' d='theliagiftcard.bo.default'} _MAX_ {intl l='elements' d='theliagiftcard.bo.default'} {intl l='in total' d='theliagiftcard.bo.default'})",
            "sInfoPostFix": "",
            "sLoadingRecords": "{intl l='Loading...' d='theliagiftcard.bo.default'}",
            "sZeroRecords": "{intl l='No element to display' d='theliagiftcard.bo.default'}",
            "sEmptyTable": "{intl l='No data available in the table' d='theliagiftcard.bo.default'}",
            "oPaginate": {
                "sFirst": "{intl l='First' d='theliagiftcard.bo.default'}",
                "sPrevious": "{intl l='Previous' d='theliagiftcard.bo.default'}",
                "sNext": "{intl l='Next' d='theliagiftcard.bo.default'}",
                "sLast": "{intl l='Last' d='theliagiftcard.bo.default'}"
            },
            "oAria": {
                "sSortAscending": ": {intl l='enable to sort by ascending order' d='theliagiftcard.bo.default'}",
                "sSortDescending": ": {intl l='enable to sort by descending order' d='theliagiftcard.bo.default'}"
            }
        }
        // initComplete: (settings, json) => {
        //     // table.column(1).data().unique().sort().each((d, j) => {
        //     //     let value = 1;
        //     //     let label = "{intl l='Generated by Admin' d='theliagiftcard.bo.default'}";

        //     //     if (d !== null) {
        //     //         value = 2;
        //     //         label = "{intl l='Buy' d='theliagiftcard.bo.default'}";
        //     //     }

        //     //     $('#js-input-type').append('<option value="' + value + '">' + label + '</option>';
        //     // });
        // }
    });


    // table.column(1).data().unique().sort().each((d, j) => {
    //     $('#js-input-type').append('<option value="' + d + '">' + d + '</option>')
    // });

    $('#js-input-type').on('change', (event) => {
        const value = parseInt(event.currentTarget.value,10);
        let searchValue = "";

        if (value === 1) {
            searchValue = "ORD";
        }

        if (value === 2) {
            searchValue = "{intl l='Generated by Admin' d='theliagiftcard.bo.default'}";
        }

        table.column(1)
             .search(searchValue)
             .draw();
    });

    function toggleTableLog(table, hidden = true) {
        if (hidden && !table.classList.contains("hidden"))
            table.classList.add("hidden");
        else if (!hidden && table.classList.contains("hidden"))
            table.classList.remove("hidden");
    }

    let giftCardStatusSelect = $('#giftcard_status_id');

    function getEmailData() {
        let statusId = giftCardStatusSelect.val();
        $('#email-customer-form input').attr('disabled', 'disabled');
        $('#email-customer-form textarea').attr('disabled', 'disabled');

        $.ajax({
            type: "GET",
            dataType: 'json',
            data: 'status_id=' + statusId,
            url: giftCardStatusSelect.data('action')
        }).success(function(data, status){

            $('#email-customer-form input').removeAttr('disabled');
            $('#email-customer-form textarea').removeAttr('disabled');
            $('#giftcard_email_subject').val(data.email_subject);
            $('#giftcard_email_text').val(data.email_text);
            $('#giftcard_email_id').val(data.id);
        }).fail(function(jqXHR, textStatus, errorThrown){

        });
    }

    getEmailData();

    giftCardStatusSelect.on('change', function () {
        getEmailData();
    });

    function refreshFormData(code, specified = null) {
        $.ajax({
            method: "POST",
            url: '{url path='/admin/module/TheliaGiftCard/show/'}' + code,
            dataType: "json",
            success: function (response) {
                $('#amount').val(response['amount']);
                $('#expirationDate').val(response['expiration_date']);
                $('#giftCardId').val(response['card_id']);

                buildTableFromLogs(response["HISTORY"]);
            }
        });
    }

    function buildTableFromLogs(logs) {

        let tbody = document.getElementById("logs-body");
        toggleTableLog(tbody.parentNode.parentNode, false);

        let columns = ['ORDER_REF', 'SPEND_AMOUNT','ORDER_STATUS', 'DATE'];
        let html = "";

        let atLeastOne = false;

        jQuery.each(logs,function (key, value) {
            html += "<tr>";
            for (let i = 0; i < columns.length; i++) {
                html += "<td>";
                html += (typeof(value[columns[i]]) != "undefined") ? value[columns[i]] : "?";
                html += "</td>";
            }

            html += "</tr>";
            atLeastOne = true;
        });

        if (!atLeastOne) {
            toggleTableLog(tbody.parentNode.parentNode);
        }

        tbody.innerHTML = html;
    };

    $('.show_manualy_edit_card_gift_dialog').on('click', function () {
        console.log($(this).attr('id'))
        $('#giftCardId').val($(this).attr('id'))
    })

    $('#manualy_edit_card_gift_dialog').on('show.bs.modal', function (e) {
        var code = $(e.relatedTarget).data('code');
        refreshFormData(code);
    });
</script>

<style>
    #dataTableGiftCard_filter {
        text-align: right;
    }
</style>
